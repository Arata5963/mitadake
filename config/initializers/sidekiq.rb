# frozen_string_literal: true

# config/initializers/sidekiq.rb
# ==========================================
# Sidekiq 設定ファイル
# ==========================================
#
# 【このファイルの役割】
# Sidekiq（バックグラウンドジョブ処理）の設定を定義する。
#
# 【Sidekiqとは？】
# Rubyで最も人気のあるバックグラウンドジョブ処理ライブラリ。
# 時間のかかる処理をバックグラウンドで非同期実行できる。
#
# 【なぜバックグラウンドジョブが必要？】
#
#   ユーザーリクエスト
#        │
#        ↓
#   重い処理（メール送信、画像処理など）
#        │
#        ↓
#   レスポンスが遅い！ ← 同期処理の問題
#
#   ↓↓ Sidekiqを使うと ↓↓
#
#   ユーザーリクエスト
#        │
#        ↓
#   ジョブをキューに追加（一瞬）
#        │
#        ↓
#   すぐにレスポンス返却
#
#   [バックグラウンドで重い処理を実行]
#
# 【このアプリでの使用例】
# - YouTubeサムネイル取得
# - AI（Gemini）でのアクションプラン生成
# - メール送信（将来的に）
#
# 【Redisとは？】
# インメモリデータベース。超高速。
# Sidekiqはジョブキューの管理にRedisを使用する。
#
# 【関連ファイル】
# - app/jobs/: ジョブクラス定義
# - config/sidekiq.yml: Sidekiqの詳細設定
# - docker-compose.yml: Redisコンテナ定義
#

# ------------------------------------------
# Redis接続URL
# ------------------------------------------
# 環境変数から取得、なければデフォルト値を使用
#
# 【URL形式】
# redis://ホスト名:ポート番号/データベース番号
#
# 【データベース番号とは？】
# Redisは1つのサーバーで複数のDBを持てる（0〜15）。
# 用途別に分けることで管理しやすくなる。
#
redis_url = ENV.fetch("REDIS_URL", "redis://redis:6379/0")

# ------------------------------------------
# サーバー側設定（Sidekiqワーカー）
# ------------------------------------------
# 【サーバーとは？】
# ジョブを実際に実行するプロセス。
# `bundle exec sidekiq` で起動する。
#
Sidekiq.configure_server do |config|
  config.redis = { url: redis_url }
end

# ------------------------------------------
# クライアント側設定（Railsアプリ）
# ------------------------------------------
# 【クライアントとは？】
# ジョブをキューに追加する側（Railsアプリ本体）。
# MyJob.perform_later(args) でジョブを追加する。
#
Sidekiq.configure_client do |config|
  config.redis = { url: redis_url }
end
