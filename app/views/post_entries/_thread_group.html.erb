<%# app/views/post_entries/_thread_group.html.erb %>
<%# 同じユーザーの投稿をスレッド形式で表示 %>

<%
  is_own ||= false
  entry_count = entries.size

  # 自分の投稿の場合、未達成エントリの期限を取得
  if is_own
    pending_entry = entries.find { |e| !e.achieved? }
    if pending_entry
      header_days = pending_entry.days_remaining
      header_status = pending_entry.deadline_status
      case header_status
      when :today
        header_badge_bg = '#fef2f2'
        header_badge_text = '#dc2626'
        header_badge_label = '今日まで'
      when :urgent
        header_badge_bg = '#fef2f2'
        header_badge_text = '#dc2626'
        header_badge_label = '残り1日'
      when :warning
        header_badge_bg = '#fffbeb'
        header_badge_text = '#d97706'
        header_badge_label = "残り#{header_days}日"
      when :expired
        header_badge_bg = '#f3f4f6'
        header_badge_text = '#6b7280'
        header_badge_label = '期限切れ'
      else
        header_badge_bg = '#f0fdf4'
        header_badge_text = '#16a34a'
        header_badge_label = "残り#{header_days}日"
      end
    else
      header_badge_label = nil
    end
  end
%>

<div class="bg-white rounded-xl overflow-hidden" style="box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
  <%# ユーザーヘッダー %>
  <div style="padding: 12px 14px 8px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f3f4f6;">
    <%# アバター %>
    <% if user.avatar.present? %>
      <%= image_tag user.avatar.url, style: "width: 28px; height: 28px; border-radius: 50%; object-fit: cover;" %>
    <% else %>
      <div style="width: 28px; height: 28px; border-radius: 50%; background: <%= is_own ? '#3b82f6' : '#e5e5ea' %>; display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 11px; font-weight: 600; color: <%= is_own ? 'white' : '#8e8e93' %>;"><%= user.name&.first&.upcase || '?' %></span>
      </div>
    <% end %>
    <%# ユーザー名 + 件数 %>
    <div style="flex: 1; min-width: 0;">
      <span style="font-size: 14px; font-weight: 600; color: #1a1a1a;"><%= user.name || '名無しさん' %></span>
      <% if entry_count > 1 %>
        <span style="font-size: 12px; color: #9ca3af; margin-left: 6px;"><%= entry_count %>件</span>
      <% end %>
    </div>
    <%# 期限バッジ（自分の投稿のみ・ヘッダー右端） %>
    <% if is_own && header_badge_label %>
      <span style="display: inline-flex; align-items: center; padding: 2px 8px; background: <%= header_badge_bg %>; border-radius: 8px; font-size: 11px; font-weight: 500; color: <%= header_badge_text %>;">
        <%= header_badge_label %>
      </span>
    <% end %>
  </div>

  <%# アクションプラン一覧（スレッド形式） %>
  <div style="padding: 0 14px 12px;">
    <% entries.each_with_index do |entry, index| %>
      <% is_last = index == entries.size - 1 %>
      <%
        # 残り日数に応じたスタイルを計算
        days = entry.days_remaining
        status = entry.deadline_status

        case status
        when :achieved
          badge_bg = '#f3f4f6'
          badge_text = '#6b7280'
          badge_label = nil
          text_style = 'text-decoration: line-through; color: #8e8e93;'
          checkbox_bg = '#000000'
          checkbox_border = nil
          show_check = true
        when :expired
          badge_bg = '#f3f4f6'
          badge_text = '#6b7280'
          badge_label = '期限切れ'
          text_style = 'text-decoration: line-through; color: #9ca3af;'
          checkbox_bg = nil
          checkbox_border = '2px solid #c7c7cc'
          show_check = false
        when :today
          badge_bg = '#fef2f2'
          badge_text = '#dc2626'
          badge_label = '今日まで'
          text_style = 'color: #1a1a1a;'
          checkbox_bg = nil
          checkbox_border = '2px solid #000000'
          show_check = false
        when :urgent
          badge_bg = '#fef2f2'
          badge_text = '#dc2626'
          badge_label = '残り1日'
          text_style = 'color: #1a1a1a;'
          checkbox_bg = nil
          checkbox_border = '2px solid #000000'
          show_check = false
        when :warning
          badge_bg = '#fffbeb'
          badge_text = '#d97706'
          badge_label = "残り#{days}日"
          text_style = 'color: #1a1a1a;'
          checkbox_bg = nil
          checkbox_border = '2px solid #000000'
          show_check = false
        else
          badge_bg = '#f0fdf4'
          badge_text = '#16a34a'
          badge_label = "残り#{days}日"
          text_style = 'color: #1a1a1a;'
          checkbox_bg = nil
          checkbox_border = '2px solid #000000'
          show_check = false
        end
      %>

      <div style="display: flex; padding-top: 12px; position: relative;">
        <%# 縦線（最後以外） %>
        <% unless is_last %>
          <div style="position: absolute; left: 10px; top: 32px; bottom: -12px; width: 2px; background: #d1d5db; z-index: 0;"></div>
        <% end %>

        <%# チェックボックス %>
        <div style="flex-shrink: 0; width: 22px; margin-right: 12px; z-index: 1;">
          <% if is_own && user_signed_in? && entry.user == current_user && !entry.achieved? %>
            <%# 未達成の場合のみクリック可能 %>
            <%= button_to achieve_post_post_entry_path(entry.post, entry),
                  method: :patch,
                  class: "block",
                  form: { data: { turbo_confirm: "「#{truncate(entry.content, length: 20)}」を達成しますか？", turbo_frame: "_top" } } do %>
              <div style="width: 22px; height: 22px; border-radius: 50%; <%= checkbox_bg ? "background: #{checkbox_bg};" : '' %> <%= checkbox_border ? "border: #{checkbox_border};" : '' %> display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;">
                <% if show_check %>
                  <svg style="width: 12px; height: 12px; color: white;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                  </svg>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <%# 達成済み or 他ユーザーの投稿（クリック不可） %>
            <div style="width: 22px; height: 22px; border-radius: 50%; <%= checkbox_bg ? "background: #{checkbox_bg};" : '' %> <%= checkbox_border ? "border: #{checkbox_border};" : '' %> display: flex; align-items: center; justify-content: center;">
              <% if show_check %>
                <svg style="width: 12px; height: 12px; color: white;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
              <% end %>
            </div>
          <% end %>
        </div>

        <%# コンテンツ %>
        <div style="flex: 1; min-width: 0;">
          <p style="font-size: 15px; line-height: 1.4; margin: 0; <%= text_style %>">
            <%= entry.content %>
          </p>
        </div>

        <%# 右端のアクション（ゴミ箱 + 炎） %>
        <div style="flex-shrink: 0; display: flex; align-items: center; gap: 8px; margin-left: 8px;">
          <%# 削除ボタン（自分の投稿のみ） %>
          <% if is_own && user_signed_in? && entry.user == current_user %>
            <%= button_to post_post_entry_path(entry.post, entry),
                  method: :delete,
                  form: { data: { turbo_confirm: "削除しますか？", turbo_frame: "_top" } },
                  style: "display: flex; align-items: center; justify-content: center; padding: 0; background: transparent; border: none; cursor: pointer;",
                  title: "削除" do %>
              <svg style="width: 16px; height: 16px; color: #c7c7cc;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            <% end %>
          <% end %>
          <%# いいねボタン %>
          <%= render "post_entries/like_button", post_entry: entry %>
        </div>
      </div>
    <% end %>
  </div>
</div>
