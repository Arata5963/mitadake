# Render.com インフラ設定（IaC）

# データベース設定
databases:
  - name: mitadake-postgres                              # Renderで表示される名前
    databaseName: mitadake_production                    # 実際のDB名
    user: mitadake_user                                  # DBユーザー名
    plan: free                                           # 無料プラン（90日で自動削除に注意）

# Webサービス設定
services:
  - type: web                                            # Webサービスとしてデプロイ
    name: mitadake                                       # サービス名（URLの一部になる）
    runtime: ruby                                        # Ruby ランタイムを使用
    buildCommand: "./bin/render-build.sh"                # ビルド時に実行するスクリプト
    startCommand: "bundle exec puma -C config/puma.rb"   # サーバー起動コマンド
    plan: free                                           # 無料プラン（15分無操作でスリープ）

    postDeploy:
      - bundle exec rails db:migrate                     # マイグレーション自動実行

    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: mitadake-postgres                        # 上で定義したDB名を参照
          property: connectionString                     # 接続文字列を取得

      - key: RAILS_MASTER_KEY
        sync: false                                      # YAMLからは同期しない（セキュリティ）

      - key: RAILS_ENV
        value: production                                # 本番環境を指定

      - key: BUNDLE_WITHOUT
        value: "development:test"                        # 本番では不要なGemをスキップ

      - key: RAILS_MAX_THREADS
        value: "2"                                       # Pumaのスレッド数（無料プランは少なめ）
