<%#
  app/views/posts/index.html.erb
  ==========================================
  投稿一覧ページ（YouTube風セクション表示）
  ==========================================

  【このページの役割】
  ログイン後のメインページ。動画一覧を表示する。

  【表示モード】
  1. @filter_user 指定時: 特定ユーザーの投稿のみ表示
  2. @filter_channel 指定時: 特定チャンネルの投稿のみ表示
  3. フィルターなし: YouTube風セクション表示
     - フィーチャー動画（自動再生ヒーロー）
     - 人気のチャンネル
     - 人気の動画ランキング
     - アクティブユーザー
     - 最近の投稿

  【Stimulusコントローラー】
  - index-search: 統合検索バー（インクリメンタル検索）

  【レンダリングされるパーシャル】
  - posts/post_card_note: 投稿カード（ノート風）
  - posts/section_*: 各セクション

  【コントローラー】
  PostsController#index
%>

<div class="min-h-screen bg-white">
  <%# ===== 統合検索バー ===== %>
  <div class="border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4 sm:px-8 py-3">
      <div class="relative"
           data-controller="index-search"
           data-index-search-search-url-value="<%= search_posts_posts_path %>">
        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4">
          <svg class="h-5 w-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <input type="text"
               data-index-search-target="input"
               data-action="input->index-search#handleInput keydown->index-search#handleKeydown"
               placeholder="動画を検索..."
               class="w-full rounded-lg border border-gray-200 bg-white pl-12 pr-4 py-3 text-base text-gray-900 placeholder:text-gray-400 focus:border-gray-400 focus:ring-2 focus:ring-gray-100 focus:outline-none transition-colors">
        <%# 検索結果ドロップダウン %>
        <div data-index-search-target="results"
             class="hidden absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-96 overflow-y-auto">
        </div>
      </div>
    </div>
  </div>

  <%# ===== メインコンテンツ ===== %>
  <div class="max-w-6xl mx-auto px-4 sm:px-8 py-6">
    <% if @filter_user.present? %>
      <%# ===== ユーザーフィルター時: 従来のグリッド表示 ===== %>
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <h1 class="text-lg font-bold text-gray-900">投稿一覧</h1>
          <span class="text-gray-400">by</span>
          <span class="text-gray-600"><%= @filter_user.name %></span>
        </div>
        <%= link_to user_profile_path(@filter_user), class: "text-sm text-gray-500 hover:text-gray-700" do %>
          ← 戻る
        <% end %>
      </div>

      <% if @posts.blank? %>
        <div class="py-16 text-center">
          <p class="text-gray-700 font-medium mb-2">まだアクションプランがありません</p>
        </div>
      <% else %>
        <div class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));">
          <% @posts.each do |post| %>
            <%= render 'posts/post_card_note', post: post %>
          <% end %>
        </div>
        <% if @posts.respond_to?(:total_pages) && @posts.total_pages > 1 %>
          <div class="mt-8 flex justify-center">
            <%= paginate @posts %>
          </div>
        <% end %>
      <% end %>

    <% elsif @filter_channel.present? %>
      <%# ===== チャンネルフィルター時: グリッド表示 ===== %>
      <div class="flex items-center mb-6">
        <%= link_to posts_path, class: "flex items-center gap-2 text-gray-900 hover:text-gray-600 transition-colors" do %>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          <span class="text-xl font-bold"><%= @filter_channel %></span>
        <% end %>
      </div>

      <% if @posts.blank? %>
        <div class="py-16 text-center">
          <span class="text-5xl block mb-4">📺</span>
          <p class="text-gray-700 font-medium mb-2">このチャンネルの投稿はまだありません</p>
        </div>
      <% else %>
        <div class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));">
          <% @posts.each do |post| %>
            <%= render 'posts/post_card_note', post: post %>
          <% end %>
        </div>
        <% if @posts.respond_to?(:total_pages) && @posts.total_pages > 1 %>
          <div class="mt-8 flex justify-center">
            <%= paginate @posts %>
          </div>
        <% end %>
      <% end %>

    <% else %>
      <%# ===== セクション表示 ===== %>

      <%# フィーチャー動画（TOP5からランダム自動再生） %>
      <% if @featured_post.present? %>
        <%= render 'posts/section_hero_video', post: @featured_post %>
      <% end %>

      <%# セクション1: 人気のチャンネル %>
      <% if @popular_channels.present? %>
        <%= render 'posts/section_channels', channels: @popular_channels %>
      <% end %>

      <%# セクション2: 人気の動画 %>
      <% if @ranking_posts.present? %>
        <%= render 'posts/section_ranking', posts: @ranking_posts %>
      <% end %>

      <%# セクション3: アクティブユーザー %>
      <% if @user_ranking.present? %>
        <%= render 'posts/section_user_ranking', users: @user_ranking %>
      <% end %>

      <%# セクション4: 最近の投稿 %>
      <% if @recent_posts.present? %>
        <%= render 'posts/section_recent_posts', posts: @recent_posts %>
      <% end %>

      <%# 空状態 %>
      <% if @popular_channels.blank? && @user_ranking.blank? && @ranking_posts.blank? && @recent_posts.blank? %>
        <div class="py-16 text-center">
          <p class="text-gray-700 font-medium mb-2">まだアクションプランがありません</p>
          <p class="text-sm text-gray-500 mb-6">動画を見て行動に変えてみましょう</p>
          <% if user_signed_in? %>
            <%= link_to new_post_path, class: "inline-flex items-center gap-2 px-6 py-2.5 bg-gray-900 text-white rounded-full font-medium hover:bg-gray-700 transition-colors" do %>
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
              </svg>
              最初のアクションプランを作成
            <% end %>
          <% else %>
            <%= link_to new_user_session_path, class: "inline-flex items-center gap-2 px-6 py-2.5 bg-gray-900 text-white rounded-full font-medium hover:bg-gray-700 transition-colors" do %>
              ログインして始める
            <% end %>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
