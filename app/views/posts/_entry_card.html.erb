<%#
  app/views/posts/_entry_card.html.erb
  ==========================================
  エントリーカード（投稿詳細ページ用）
  ==========================================

  【このパーシャルの役割】
  投稿詳細ページ（posts/show）でアクションプランを表示する
  YouTubeサムネイル風のカードコンポーネント。

  【パラメータ】
  - entry: PostEntryオブジェクト
  - post: Postオブジェクト

  【表示内容】
  - サムネイル画像（達成記録画像 > 投稿時画像 > YouTubeサムネ）
  - アクションプラン内容
  - ユーザー情報（アバター + 名前）
  - いいねボタン（ログイン時のみ操作可能）

  【達成済みカード】
  達成済みの場合、クリックすると達成記録モーダルを表示。
  achievement-card Stimulusコントローラーで制御。

  【Stimulusコントローラー】
  achievement-card: 達成記録モーダルの開閉
%>

<%
  user = entry.user
  # 達成済みの場合は達成記録画像を優先、なければ投稿時サムネ、なければYouTubeサムネ
  if entry.achieved?
    display_thumbnail = entry.signed_result_image_url || entry.signed_thumbnail_url || "https://i.ytimg.com/vi/#{post.youtube_video_id}/mqdefault.jpg"
  else
    display_thumbnail = entry.signed_thumbnail_url || "https://i.ytimg.com/vi/#{post.youtube_video_id}/mqdefault.jpg"
  end
%>

<article class="group"
         <% if entry.achieved? %>
           data-controller="achievement-card"
           data-achievement-card-entry-id-value="<%= entry.id %>"
           data-achievement-card-post-id-value="<%= post.id %>"
           data-achievement-card-show-url-value="<%= show_achievement_post_post_entry_path(post, entry) %>"
           data-achievement-card-mode-value="display"
           data-achievement-card-hide-original-video-value="true"
         <% end %>>
  <div class="relative rounded-lg overflow-hidden bg-gray-100 aspect-video <%= 'cursor-pointer' if entry.achieved? %>"
       <% if entry.achieved? %>
         data-action="click->achievement-card#open"
       <% end %>>
    <%= image_tag display_thumbnail,
          alt: entry.content,
          class: "w-full h-full object-cover group-hover:scale-105 transition-transform duration-200",
          loading: "lazy" %>
  </div>
  <div class="pt-2">
    <p class="text-sm font-medium text-gray-900 leading-tight line-clamp-2 <%= 'cursor-pointer' if entry.achieved? %>"
       <% if entry.achieved? %>
         data-action="click->achievement-card#open"
       <% end %>>
      <%= entry.content %>
    </p>
    <div class="flex items-center justify-between mt-2">
      <%= link_to user_profile_path(user), style: "display: flex; align-items: center; gap: 6px; text-decoration: none;" do %>
        <%= render "shared/avatar", user: user, size: :sm, lazy: true %>
        <span style="font-size: 12px; color: #6b7280;"><%= user.name.presence || "名無しさん" %></span>
      <% end %>

      <%# いいねボタン（ハート） %>
      <% if user_signed_in? %>
        <%= button_to toggle_like_post_post_entry_path(post, entry),
              method: :post,
              class: "flex items-center gap-1 text-xs transition-colors hover:opacity-70",
              form: { data: { turbo_frame: "_top" } } do %>
          <% if entry.liked_by?(current_user) %>
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="#e8a0a0">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            <span style="color: #c08080;"><%= entry.entry_likes.count %></span>
          <% else %>
            <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            <span class="text-gray-400"><%= entry.entry_likes.count %></span>
          <% end %>
        <% end %>
      <% else %>
        <div class="flex items-center gap-1 text-xs text-gray-400">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
          <span><%= entry.entry_likes.count %></span>
        </div>
      <% end %>
    </div>
  </div>
</article>
