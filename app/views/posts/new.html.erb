<%#
  app/views/posts/new.html.erb
  ==========================================
  新規投稿ページ
  ==========================================

  【このページの役割】
  YouTube動画とアクションプランを投稿するフォーム。
  すべてStimulusコントローラーで制御される。

  【投稿フロー】
  1. YouTube検索で動画を選択
  2. アクションプランを入力（AI提案あり）
  3. サムネイル画像をアップロード（任意）
  4. 投稿ボタンで送信

  【Stimulusコントローラー】
  post-create:
    - handleInput: YouTube検索
    - handleKeydown: キーボード操作
    - clearSelection: 動画選択解除
    - fetchAiSuggestions: AIによるアクションプラン提案
    - convertToYouTubeTitle: アクションプランをYouTube風タイトルに変換
    - handleFileSelect: サムネイル画像アップロード
    - submitForm: フォーム送信（Ajax）

  【API連携】
  - youtube_search_posts_path: YouTube動画検索API
  - suggest_action_plans_posts_path: AI提案API（Gemini）
  - convert_to_youtube_title_posts_path: タイトル変換API（Gemini）
  - create_with_action_posts_path: 投稿作成API

  【コントローラー】
  PostsController#new, PostsController#create_with_action
%>
<% content_for :title, "新規投稿" %>

<div class="min-h-[calc(100vh-56px)] bg-white">
  <div class="max-w-5xl mx-auto px-5 py-6"
       data-controller="post-create"
       data-post-create-youtube-url-value="<%= youtube_search_posts_path %>"
       data-post-create-create-url-value="<%= create_with_action_posts_path %>"
       data-post-create-suggest-url-value="<%= suggest_action_plans_posts_path %>"
       data-post-create-convert-url-value="<%= convert_to_youtube_title_posts_path %>">

    <%# ヘッダー部分 %>
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-lg font-semibold text-gray-900">投稿を作成</h1>
      <button type="button"
              data-post-create-target="submitButton"
              data-action="click->post-create#submitForm"
              disabled
              class="px-5 py-2 rounded-full bg-gray-300 text-white text-sm font-semibold border-none cursor-not-allowed transition-all duration-200">
        投稿
      </button>
    </div>

    <%# 動画選択セクション %>
    <div class="mb-6">
      <label class="block text-sm font-semibold text-gray-900 mb-3">動画を選択</label>

      <%# 検索入力 %>
      <div class="relative">
        <input type="text"
               data-post-create-target="input"
               data-action="input->post-create#handleInput keydown->post-create#handleKeydown"
               placeholder="YouTubeで検索..."
               autofocus
               class="w-full px-4 py-3 border border-gray-200 rounded-lg text-base text-gray-900 outline-none focus:border-gray-900 transition-colors">

        <%# 検索結果ドロップダウン %>
        <div data-post-create-target="results"
             class="hidden absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-[300px] overflow-y-auto">
        </div>
      </div>

      <%# 動画プレビュー %>
      <div data-post-create-target="preview" class="hidden mt-3">
        <div class="flex gap-3 p-3 bg-gray-50 rounded-lg">
          <img data-post-create-target="previewThumbnail" src="" alt="" class="w-[120px] h-[68px] object-cover rounded flex-shrink-0">
          <div class="flex-1 min-w-0">
            <p data-post-create-target="previewTitle" class="text-sm font-medium text-gray-900 mb-1 leading-snug line-clamp-2"></p>
            <p data-post-create-target="previewChannel" class="text-xs text-gray-500"></p>
          </div>
          <button type="button"
                  data-action="click->post-create#clearSelection"
                  class="flex-shrink-0 px-2 py-1 bg-transparent border-none text-gray-500 text-xs cursor-pointer hover:text-gray-700">
            ✕
          </button>
        </div>
      </div>
    </div>

    <%# アクションプラン入力セクション %>
    <div class="mb-6">
      <div class="flex items-center justify-between mb-3">
        <label class="text-sm font-semibold text-gray-900">アクションプラン</label>

        <div class="flex gap-2 items-center">
          <%# YouTubeタイトル風に変換ボタン %>
          <button type="button"
                  data-post-create-target="convertButton"
                  data-action="click->post-create#convertToYouTubeTitle"
                  class="hidden items-center gap-1 px-3 py-1.5 bg-white border border-gray-900 rounded-full text-gray-900 text-xs font-medium cursor-pointer">
            タイトル風に変換
          </button>

          <%# AI提案ボタン %>
          <div data-post-create-target="suggestions" class="hidden">
            <button type="button"
                    data-post-create-target="suggestButton"
                    data-action="click->post-create#fetchAiSuggestions"
                    class="inline-flex items-center gap-1 px-3 py-1.5 bg-white border border-gray-900 rounded-full text-gray-900 text-xs font-medium cursor-pointer">
              AI提案
            </button>
          </div>
        </div>
      </div>

      <%# AI提案リスト %>
      <div data-post-create-target="suggestionsContainer" class="mb-3"></div>

      <%# テキストエリア %>
      <div class="border border-gray-200 rounded-lg transition-colors duration-200 focus-within:border-gray-900" data-post-create-target="inputWrapper">
        <textarea
          data-post-create-target="actionPlanInput"
          data-action="input->post-create#handleActionPlanInput focus->post-create#focusInput blur->post-create#blurInput"
          placeholder="例：【実践】1日スマホなしで過ごしてみた"
          rows="3"
          class="w-full border-none bg-transparent px-4 py-3 text-base text-gray-900 resize-none outline-none leading-relaxed"
        ></textarea>
      </div>

      <p class="text-xs text-gray-500 mt-2">※ YouTubeのタイトル風にアクションプランを設定しよう</p>
    </div>

    <%# 達成コレクションプレビュー（サムネイルクリックでアップロード） %>
    <div data-post-create-target="collectionPreview" class="hidden mb-6">
      <label class="block text-sm font-semibold text-gray-900 mb-3">サムネイル画像</label>
      <div>
        <div class="max-w-xs">
          <%# サムネイル部分（クリックでアップロード） %>
          <div class="relative">
            <label data-post-create-target="previewCard" class="relative block rounded-lg overflow-hidden bg-gray-100 aspect-video cursor-pointer transition-all duration-200">
              <%# アップロード前の状態 %>
              <div data-post-create-target="uploadPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg transition-all duration-200 hover:border-gray-900 hover:bg-black/5">
                <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="text-sm font-medium text-gray-600">クリックして画像を選択</span>
                <span class="text-xs text-gray-400 mt-1">JPG, PNG（最大5MB）</span>
              </div>
              <%# アップロード後の画像 %>
              <img data-post-create-target="previewImage" src="" alt="" class="hidden w-full h-full object-cover">
              <%# ファイル入力（非表示） %>
              <input type="file"
                     accept="image/jpeg,image/png,image/webp"
                     data-post-create-target="fileInput"
                     data-action="change->post-create#handleFileSelect"
                     class="hidden">
            </label>
            <%# 右上の×ボタン（アップロード後に表示） %>
            <button type="button"
                    data-post-create-target="clearImageButton"
                    data-action="click->post-create#clearImage"
                    class="hidden absolute -top-2 -right-2 w-6 h-6 bg-gray-900 text-white border-none rounded-full cursor-pointer items-center justify-center text-xs z-10">
              ✕
            </button>
          </div>
          <%# カード下部 %>
          <div class="pt-2">
            <p data-post-create-target="previewActionPlan" class="text-sm font-medium text-gray-900 leading-snug line-clamp-2">アクションプランがここに表示されます</p>
            <div class="flex items-center gap-1.5 mt-1.5">
              <div class="w-6 h-6 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500"></div>
              <span class="text-xs text-gray-500"><%= current_user&.name || "あなた" %></span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
