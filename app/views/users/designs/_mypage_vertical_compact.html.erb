<%# app/views/users/designs/_mypage_vertical_compact.html.erb %>
<%# デザイン: 投稿一覧と同じヒーロービデオスタイル %>

<% is_own_page = local_assigns[:is_own_page].nil? ? true : is_own_page %>
<% current_action = user.current_action_plan %>
<% current_video = user.current_video %>

<div style="max-width: 1000px; margin: 0 auto; padding: 16px 20px 24px;">
  <%# プロフィール %>
  <div class="flex items-center gap-3 mb-6">
    <%= render "shared/avatar", user: user, size: :xl %>
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-1.5">
        <h1 class="text-xl font-bold text-gray-900 truncate"><%= user.name.presence || "名無しさん" %></h1>
        <% if is_own_page %>
          <%= link_to edit_profile_path, class: "p-0.5 text-gray-400 hover:text-gray-600" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
          <% end %>
        <% end %>
      </div>
      <% if user.favorite_quote.present? %>
        <% if is_own_page %>
          <%= link_to edit_profile_path, class: "block text-sm text-gray-600 mt-1 hover:text-gray-900 transition-colors" do %>
            「<%= user.favorite_quote %>」
          <% end %>
        <% else %>
          <p class="text-sm text-gray-600 mt-1">「<%= user.favorite_quote %>」</p>
        <% end %>
      <% end %>
    </div>
  </div>

  <% if current_video && current_action %>
    <%
      custom_thumbnail = current_action.signed_thumbnail_url
      youtube_thumbnail = "https://i.ytimg.com/vi/#{current_video.youtube_video_id}/mqdefault.jpg"
      display_thumbnail = custom_thumbnail.presence || youtube_thumbnail
    %>

    <%# ステップバッジデザイン %>
    <section class="mb-6">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
        <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #111; color: #fff; font-size: 12px; font-weight: 700;">1</span>
        <span style="font-size: 14px; font-weight: 600; color: #111;">きっかけの動画</span>
      </div>
      <div data-controller="hero-video" data-hero-video-video-id-value="<%= current_video.youtube_video_id %>" style="margin-bottom: 24px;">
        <div class="group relative rounded-xl overflow-hidden bg-black cursor-pointer" style="aspect-ratio: 16/9;">
          <iframe id="hero-player-<%= current_video.youtube_video_id %>" data-hero-video-target="iframe" src="https://www.youtube.com/embed/<%= current_video.youtube_video_id %>?autoplay=1&mute=1&loop=1&playlist=<%= current_video.youtube_video_id %>&controls=0&playsinline=1&rel=0&modestbranding=1&showinfo=0&enablejsapi=1" class="absolute inset-0 w-full h-full pointer-events-none" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          <div class="absolute inset-0 z-10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300" data-action="click->hero-video#toggle">
            <div class="absolute inset-0 bg-black/30"></div>
            <button type="button" class="relative z-10 w-14 h-14 rounded-full bg-white/90 hover:bg-white flex items-center justify-center shadow-lg">
              <svg data-hero-video-target="playButton" class="w-6 h-6 text-black ml-1 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
              <svg data-hero-video-target="pauseButton" class="w-6 h-6 text-black" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
          </div>
        </div>
        <%= link_to post_path(current_video), class: "block mt-3" do %>
          <p class="text-base font-bold text-gray-900 line-clamp-2 leading-snug"><%= current_video.youtube_title %></p>
          <div class="flex items-center gap-2 mt-1.5">
            <% if current_video.youtube_channel_thumbnail_url.present? %>
              <%= image_tag current_video.youtube_channel_thumbnail_url, class: "w-5 h-5 rounded-full", alt: current_video.youtube_channel_name %>
            <% end %>
            <span class="text-sm text-gray-500"><%= current_video.youtube_channel_name %></span>
          </div>
        <% end %>
      </div>

      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
        <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #111; color: #fff; font-size: 12px; font-weight: 700;">2</span>
        <span style="font-size: 14px; font-weight: 600; color: #111;">私のアクション</span>
      </div>
      <%= render 'users/designs/action_plan_card', current_video: current_video, current_action: current_action, display_thumbnail: display_thumbnail, user: user, is_own_page: is_own_page %>
    </section>
  <% else %>
    <%# Empty State %>
    <% if is_own_page %>
      <div class="bg-gray-50 rounded-xl py-6 px-4 text-center">
        <p class="text-sm text-gray-600 mb-3">アクションプランがありません</p>
        <%= link_to posts_path, class: "inline-flex items-center gap-2 px-4 py-2 bg-gray-900 text-white text-sm rounded-full font-medium hover:bg-gray-700 transition-colors" do %>
          動画を探す
        <% end %>
      </div>
    <% else %>
      <div class="bg-gray-50 rounded-xl py-6 px-4 text-center">
        <p class="text-sm text-gray-600">挑戦中のアクションプランはありません</p>
      </div>
    <% end %>
  <% end %>

  <%# 達成コレクション（デザイン切り替え対応） %>
  <% achieved_entries = user.post_entries.achieved.includes(:post).order(achieved_at: :desc) %>
  <% if achieved_entries.present? %>
    <%= render 'users/collections/collection_section',
          achieved_entries: achieved_entries,
          user: user,
          is_own_page: is_own_page %>
  <% end %>
</div>
