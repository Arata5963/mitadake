<%# app/views/users/show.html.erb %>
<% content_for :title, @is_own_page ? "„Éû„Ç§„Éö„Éº„Ç∏" : "#{@user.name}„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´" %>

<div class="min-h-screen bg-gray-50">
  <% if @is_own_page %>
    <%
      total_tasks = @todays_tasks.size + @overdue_tasks.size + @upcoming_tasks.size + @completed_tasks.size
      completed_count = @completed_tasks.size
      pending_count = total_tasks - completed_count
      completion_rate = total_tasks > 0 ? (completed_count.to_f / total_tasks * 100).round : 0
      pending_tasks = @overdue_tasks + @todays_tasks + @upcoming_tasks
    %>

    <div class="max-w-2xl mx-auto px-4 py-6">
      <%# ===== „Éó„É≠„Éï„Ç£„Éº„É´„Éò„ÉÉ„ÉÄ„Éº ===== %>
      <div class="mb-8">
        <div class="flex items-center gap-4">
          <%# „Ç¢„Éê„Çø„Éº %>
          <% if @user.avatar.present? %>
            <%= image_tag @user.avatar.url, class: "w-16 h-16 sm:w-20 sm:h-20 rounded-full object-cover flex-shrink-0" %>
          <% else %>
            <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
              <svg class="w-8 h-8 sm:w-10 sm:h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
              </svg>
            </div>
          <% end %>

          <%# ÂêçÂâç %>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <h1 class="text-xl sm:text-2xl font-bold text-gray-900 truncate"><%= @user.name.presence || "ÂêçÁÑ°„Åó„Åï„Çì" %></h1>
              <%= link_to edit_profile_path, class: "p-1.5 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100" do %>
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125" />
                </svg>
              <% end %>
            </div>
          </div>

          <%# ÈÅîÊàêÁéá„Ç∞„É©„Éï %>
          <div class="flex-shrink-0 flex flex-col items-center">
            <div class="relative w-14 h-14 sm:w-16 sm:h-16">
              <svg class="w-full h-full -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="42" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="42" stroke="#22c55e" stroke-width="8" fill="none"
                        stroke-dasharray="<%= 263.9 * completion_rate / 100 %> 263.9"
                        stroke-linecap="round"/>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-sm sm:text-base font-bold text-gray-900"><%= completion_rate %><span class="text-[10px] text-gray-400">%</span></span>
              </div>
            </div>
            <p class="text-[10px] text-gray-400 mt-1">ÈÅîÊàêÁéá</p>
          </div>
        </div>

        <%# ÂºïÁî®ÔºàÂà•Ë°åÔºâ %>
        <% if @user.favorite_quote.present? %>
          <%= link_to @user.favorite_quote_url.presence || "#", target: @user.favorite_quote_url.present? ? "_blank" : nil, rel: "noopener noreferrer", class: "mt-3 flex items-start gap-2 group hover:opacity-80 transition-opacity" do %>
            <svg class="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
            </svg>
            <p class="text-sm text-gray-500 italic group-hover:text-gray-700">„Äå<%= @user.favorite_quote %>„Äç</p>
          <% end %>
        <% end %>
      </div>

      <%# ===== „ÇÑ„Çã„Åì„Å®„É™„Çπ„Éà ===== %>
      <section class="mb-8">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-base font-bold text-gray-900">„ÇÑ„Çã„Åì„Å®</h2>
          <span class="text-sm text-gray-400"><%= pending_count %>‰ª∂</span>
        </div>

        <% if pending_tasks.any? %>
          <% grouped_tasks = pending_tasks.group_by { |t| t.post } %>
          <div class="space-y-4">
            <% grouped_tasks.each do |post, tasks| %>
              <div class="border border-gray-100 rounded-xl overflow-hidden">
                <% if post %>
                  <%= link_to post_path(post), class: "flex items-center gap-2 sm:gap-3 p-2 sm:p-3 bg-gray-50 hover:bg-gray-100 transition-colors" do %>
                    <img src="<%= post.youtube_thumbnail_url(size: :default) %>"
                         alt="<%= post.youtube_title %>"
                         class="w-16 h-10 sm:w-20 sm:h-12 object-cover rounded-lg flex-shrink-0">
                    <div class="flex-1 min-w-0">
                      <p class="text-xs sm:text-sm font-medium text-gray-900 line-clamp-2 sm:line-clamp-1"><%= post.youtube_title %></p>
                      <p class="text-[10px] sm:text-xs text-gray-400 mt-0.5 line-clamp-1"><%= post.youtube_channel_name %></p>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                  <% end %>
                <% end %>
                <div class="divide-y divide-gray-50">
                  <% tasks.each do |task| %>
                    <div class="flex items-start gap-2 sm:gap-3 p-2 sm:p-3">
                      <%= button_to achieve_post_post_entry_path(task.post, task),
                            method: :patch,
                            class: "flex-shrink-0 mt-0.5 cursor-pointer hover:scale-110 transition-transform",
                            form: { data: { turbo_confirm: "„Äå#{truncate(task.content, length: 20)}„Äç„ÇíÈÅîÊàê„Åó„Åæ„Åô„ÅãÔºü" } } do %>
                        <div class="w-5 h-5 rounded-full border-2 border-gray-300 hover:bg-gray-100"></div>
                      <% end %>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-900 line-clamp-2"><%= task.content %></p>
                        <% if task.deadline %>
                          <p class="text-xs mt-1 text-gray-400">
                            <%= l(task.deadline, format: :short) %>
                          </p>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="py-8 text-center">
            <span class="text-3xl">üéâ</span>
            <p class="text-sm text-gray-500 mt-2">„Åô„Åπ„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÇíÈÅîÊàê„Åó„Åæ„Åó„Åü!</p>
          </div>
        <% end %>
      </section>

      <%# ===== „ÇÑ„Å£„Åü„É™„Çπ„Éà ===== %>
      <section class="mb-8">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-base font-bold text-gray-900">„ÇÑ„Å£„Åü„Åì„Å®</h2>
          <span class="text-sm text-gray-400"><%= completed_count %>‰ª∂</span>
        </div>

        <% if @completed_tasks.any? %>
          <% grouped_completed = @completed_tasks.group_by { |t| t.post } %>
          <div class="space-y-4">
            <% grouped_completed.each do |post, tasks| %>
              <div class="border border-gray-100 rounded-xl overflow-hidden">
                <% if post %>
                  <%= link_to post_path(post), class: "flex items-center gap-2 sm:gap-3 p-2 sm:p-3 bg-green-50/50 hover:bg-green-50 transition-colors" do %>
                    <img src="<%= post.youtube_thumbnail_url(size: :default) %>"
                         alt="<%= post.youtube_title %>"
                         class="w-16 h-10 sm:w-20 sm:h-12 object-cover rounded-lg flex-shrink-0">
                    <div class="flex-1 min-w-0">
                      <p class="text-xs sm:text-sm font-medium text-gray-900 line-clamp-2 sm:line-clamp-1"><%= post.youtube_title %></p>
                      <p class="text-[10px] sm:text-xs text-gray-400 mt-0.5 line-clamp-1"><%= post.youtube_channel_name %></p>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                  <% end %>
                <% end %>
                <div class="divide-y divide-gray-50">
                  <% tasks.each do |task| %>
                    <div class="flex items-start gap-2 sm:gap-3 p-2 sm:p-3">
                      <%= button_to achieve_post_post_entry_path(task.post, task),
                            method: :patch,
                            class: "flex-shrink-0 mt-0.5 cursor-pointer hover:scale-110 transition-transform",
                            form: { data: { turbo_confirm: "„Äå#{truncate(task.content, length: 20)}„Äç„ÇíÊú™ÈÅîÊàê„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü" } } do %>
                        <div class="w-5 h-5 rounded-full bg-gray-900 flex items-center justify-center hover:bg-gray-700">
                          <svg class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                          </svg>
                        </div>
                      <% end %>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-500 line-through line-clamp-2"><%= task.content %></p>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="py-8 text-center">
            <span class="text-3xl">üìù</span>
            <p class="text-sm text-gray-500 mt-2">„Åæ„Å†ÈÅîÊàê„Åó„Åü„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
            <p class="text-xs text-gray-400 mt-1">ÂãïÁîª„ÇíË¶ã„Å¶„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Çá„ÅÜ</p>
          </div>
        <% end %>
      </section>

    </div>

  <% else %>
    <%# ===== ‰ªñ„É¶„Éº„Ç∂„Éº„ÅÆ„Éö„Éº„Ç∏ ===== %>
    <div class="max-w-4xl mx-auto px-4 py-8">
      <div class="flex items-center gap-4 mb-8">
        <% if @user.avatar.present? %>
          <%= image_tag @user.avatar.url, class: "w-16 h-16 rounded-full object-cover" %>
        <% else %>
          <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center">
            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
            </svg>
          </div>
        <% end %>
        <div>
          <h1 class="text-2xl font-bold text-gray-900"><%= @user.name.presence || "ÂêçÁÑ°„Åó„Åï„Çì" %></h1>
          <% if @user.favorite_quote.present? %>
            <p class="text-gray-500 text-sm mt-1">„Äå<%= @user.favorite_quote %>„Äç</p>
          <% end %>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm p-6">
        <h3 class="font-bold text-gray-900 mb-4">ÊäïÁ®ø„Åó„ÅüÂãïÁîª</h3>
        <% if @user_posts.any? %>
          <div class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));">
            <% @user_posts.each do |post| %>
              <%= render 'posts/post_card_note', post: post %>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-400 text-center py-8">„Åæ„Å†ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
