<%# アクションプラン編集ページ %>
<%# 動画・アクションプラン・サムネイル画像を編集するフォーム %>
<% content_for :title, "アクションプラン編集" %>
<% from_mypage = params[:from] == 'mypage' %>

<%
  # サムネイル: カスタムアップロードがあればそれを使用、なければYouTubeサムネイル
  custom_thumbnail = @entry.signed_thumbnail_url
  youtube_thumbnail = "https://i.ytimg.com/vi/#{@post.youtube_video_id}/mqdefault.jpg"
  current_thumbnail = custom_thumbnail.presence || youtube_thumbnail
  has_custom_thumbnail = custom_thumbnail.present?
%>

<div class="min-h-[calc(100vh-56px)] bg-white">
  <div class="max-w-2xl mx-auto px-5 py-6"
       data-controller="entry-edit"
       data-entry-edit-youtube-url-value="<%= youtube_search_posts_path %>"
       data-entry-edit-update-url-value="<%= post_post_entry_path(@post, @entry, from: params[:from]) %>"
       data-entry-edit-current-post-id-value="<%= @post.id %>"
       data-entry-edit-current-video-id-value="<%= @post.youtube_video_id %>"
       data-entry-edit-current-video-title-value="<%= @post.youtube_title %>"
       data-entry-edit-current-video-channel-value="<%= @post.youtube_channel_name %>"
       data-entry-edit-current-video-url-value="<%= @post.youtube_url %>"
       data-entry-edit-current-thumbnail-value="<%= current_thumbnail %>"
       data-entry-edit-has-custom-thumbnail-value="<%= has_custom_thumbnail %>"
       data-entry-edit-redirect-url-value="<%= from_mypage ? mypage_path : post_path(@post) %>">

    <%# ヘッダー %>
    <h1 class="text-xl font-bold text-gray-900 mb-8">編集</h1>

    <%# 動画選択セクション %>
    <div class="mb-6">
      <label class="block text-xs text-gray-500 mb-1">動画を選択</label>

      <%# 検索入力 %>
      <div class="relative">
        <input type="text"
               data-entry-edit-target="input"
               data-action="input->entry-edit#handleInput keydown->entry-edit#handleKeydown"
               placeholder="YouTubeで検索..."
               class="w-full px-0 py-2 border-0 border-b border-gray-300 text-gray-900 placeholder-gray-300 focus:border-gray-900 focus:ring-0 focus:outline-none transition-colors bg-transparent">

        <%# 検索結果ドロップダウン %>
        <div data-entry-edit-target="results"
             class="hidden absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-[300px] overflow-y-auto">
        </div>
      </div>

      <%# 動画プレビュー %>
      <div data-entry-edit-target="preview" class="mt-3">
        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
          <img data-entry-edit-target="previewThumbnail" src="https://img.youtube.com/vi/<%= @post.youtube_video_id %>/sddefault.jpg" alt="" class="w-20 h-12 object-cover rounded flex-shrink-0">
          <div class="flex-1 min-w-0">
            <p data-entry-edit-target="previewTitle" class="text-sm font-medium text-gray-900 line-clamp-2"><%= @post.youtube_title %></p>
            <p data-entry-edit-target="previewChannel" class="text-xs text-gray-500 mt-0.5"><%= @post.youtube_channel_name %></p>
          </div>
          <button type="button"
                  data-action="click->entry-edit#clearSelection"
                  class="flex-shrink-0 text-gray-400 hover:text-gray-600">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <%# アクションプラン入力セクション %>
    <div class="mb-6">
      <label class="block text-xs text-gray-500 mb-1">アクションプラン</label>

      <%# テキストエリア %>
      <textarea
        data-entry-edit-target="actionPlanInput"
        data-action="input->entry-edit#handleActionPlanInput"
        placeholder="【実践】紹介されてた商品を買ってみた"
        rows="1"
        class="w-full px-0 py-2 border-0 border-b border-gray-300 text-gray-900 placeholder-gray-300 focus:border-gray-900 focus:ring-0 focus:outline-none transition-colors bg-transparent resize-none overflow-hidden"
      ><%= @entry.content %></textarea>

      <p class="text-xs text-gray-400 mt-2">※ YouTubeのタイトル風に書いてみよう</p>
    </div>

    <%# サムネイル画像セクション %>
    <div class="mb-6">
      <label class="block text-xs text-gray-500 mb-1">サムネイル画像</label>
      <div>
        <div style="width: 320px;">
          <%# サムネイル（クリックでアップロード） %>
          <div class="relative">
            <label data-entry-edit-target="previewCard" class="relative block rounded-lg overflow-hidden bg-gray-100 aspect-video cursor-pointer transition-all duration-200">
              <%# アップロード前の状態 %>
              <div data-entry-edit-target="uploadPlaceholder" class="<%= has_custom_thumbnail ? 'hidden' : 'flex' %> absolute inset-0 flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg transition-all duration-200 hover:border-gray-900 hover:bg-black/5">
                <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="text-sm font-medium text-gray-600">クリックして画像を選択</span>
                <span class="text-xs text-gray-400 mt-1">JPG, PNG（最大10MB）</span>
              </div>
              <%# アップロード後の画像 %>
              <img data-entry-edit-target="previewImage" src="<%= current_thumbnail %>" alt="" class="<%= has_custom_thumbnail ? 'block' : 'hidden' %> w-full h-full object-cover">
              <%# ファイル入力（非表示） %>
              <input type="file"
                     accept="image/jpeg,image/png,image/webp"
                     data-entry-edit-target="fileInput"
                     data-action="change->entry-edit#handleFileSelect"
                     class="hidden">
            </label>
            <%# 右上の×ボタン %>
            <button type="button"
                    data-entry-edit-target="clearImageButton"
                    data-action="click->entry-edit#clearImage"
                    class="<%= has_custom_thumbnail ? 'flex' : 'hidden' %> absolute -top-2 -right-2 w-6 h-6 bg-gray-900 text-white border-none rounded-full cursor-pointer items-center justify-center text-xs z-10">
              ✕
            </button>
          </div>
          <%# カード下部 %>
          <div class="pt-2">
            <p data-entry-edit-target="previewText" class="text-sm font-medium text-gray-900 leading-snug line-clamp-2"><%= @entry.content %></p>
            <div class="flex items-center gap-1.5 mt-1.5">
              <%= render "shared/avatar", user: current_user, size: :sm, fallback: :gradient %>
              <span class="text-xs text-gray-500"><%= current_user.name.presence || "あなた" %></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%# 更新ボタン %>
    <div class="pt-4">
      <button type="button"
              data-entry-edit-target="submitButton"
              data-action="click->entry-edit#submitForm"
              class="w-full bg-gray-900 text-white py-3 text-sm font-medium transition-colors hover:bg-gray-800">
        更新
      </button>
    </div>

    <%# 削除リンク %>
    <div class="pt-6 mt-6 border-t border-gray-100">
      <%= button_to "このアクションプランを削除",
            post_post_entry_path(@post, @entry, from: params[:from]),
            method: :delete,
            class: "bg-transparent border-none text-red-600 text-sm cursor-pointer p-0 hover:text-red-700",
            form: { data: { turbo_confirm: "このアクションプランを削除しますか？" } } %>
    </div>

  </div>
</div>
