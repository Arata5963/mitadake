<%# app/views/posts/show.html.erb %>
<%# 動画詳細ページ（シンプル版） %>
<% content_for :title, @post.youtube_title&.truncate(30) || "動画詳細" %>

<div class="min-h-screen bg-white">
  <%# ===== メインコンテンツエリア（1000px幅・中央配置） ===== %>
  <div style="max-width: 1000px; margin: 0 auto; padding: 0 20px;" class="pt-6">

    <%# ===== ヒーロー: YouTube サムネイル ===== %>
    <%= link_to @post.youtube_url,
          target: "_blank",
          rel: "noopener noreferrer",
          class: "block relative group mb-8" do %>
      <div class="aspect-video w-full rounded-lg overflow-hidden bg-gray-100">
        <%= image_tag @post.youtube_thumbnail_url(size: :hqdefault),
              alt: @post.youtube_title,
              class: "w-full h-full object-cover group-hover:scale-105 transition-transform duration-300",
              loading: "lazy",
              onerror: "this.src='#{@post.youtube_thumbnail_url(size: :mqdefault)}'" %>
      </div>
      <%# 再生ボタン %>
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="w-14 h-14 bg-black/60 rounded-full flex items-center justify-center group-hover:bg-gray-700 group-hover:scale-110 transition-all duration-300">
          <svg class="w-6 h-6 text-white ml-0.5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </div>
      </div>
      <%# YouTube ラベル %>
      <div class="absolute top-3 left-3 flex items-center gap-1.5 bg-black/60 text-white text-xs px-2 py-1 rounded">
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
        </svg>
        <span>YouTubeで見る</span>
      </div>
    <% end %>

    <%# ===== タイトル ===== %>
    <h1 style="font-size: 22px; font-weight: 700; color: #1a1a1a; line-height: 1.4; margin-bottom: 12px;">
      <%= @post.youtube_title %>
    </h1>

    <%# ===== チャンネル名 ===== %>
    <% if @post.youtube_channel_name.present? %>
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
        <% if @post.youtube_channel_thumbnail_url.present? %>
          <%= image_tag @post.youtube_channel_thumbnail_url,
                style: "width: 24px; height: 24px; border-radius: 50%; object-fit: cover;",
                alt: @post.youtube_channel_name,
                loading: "lazy" %>
        <% else %>
          <div style="width: 24px; height: 24px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center;">
            <svg style="width: 14px; height: 14px; color: #9ca3af;" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
          </div>
        <% end %>
        <p style="font-size: 14px; color: #6b7280;">
          <%= @post.youtube_channel_name %>
        </p>
      </div>
    <% end %>

    <%# ===== ユーザー数 & ランキング ===== %>
    <div class="mb-5" style="display: flex; align-items: center; gap: 8px;">
      <span class="text-xs text-gray-400"><%= @post.post_entries.achieved.count %>人がアクションプランを達成</span>
      <% if (rank = @post.action_count_rank) %>
        <span style="display: inline-flex; align-items: center; padding: 2px 8px; background: #f3f4f6; border-radius: 10px; font-size: 11px; font-weight: 600; color: #374151;">
          TOP <%= rank %>
        </span>
      <% end %>
    </div>

    <%# 下部余白 %>
    <div style="height: 24px;"></div>
  </div>

  <%# ===== アクションプランセクション（フルワイド） ===== %>
  <section style="border-top: 1px solid #f3f4f6; padding-top: 32px; margin-bottom: 32px;">
    <div style="max-width: 1000px; margin: 0 auto; padding: 0 20px;">
      <%
        achieved_entries = @post.post_entries.achieved.includes(:user).order(achieved_at: :desc)
        pending_entries = @post.post_entries.not_achieved.includes(:user).order(created_at: :desc)
        current_tab = params[:tab] || 'achieved'
      %>

      <%# タブ切り替え %>
      <div class="flex gap-1 mb-6 border-b border-gray-200">
        <%= link_to post_path(@post, tab: 'achieved'),
            class: "px-4 py-2 text-sm font-medium transition-colors #{current_tab == 'achieved' ? 'text-gray-900 border-b-2 border-gray-900 -mb-px' : 'text-gray-500 hover:text-gray-700'}" do %>
          達成 (<%= achieved_entries.count %>)
        <% end %>
        <%= link_to post_path(@post, tab: 'pending'),
            class: "px-4 py-2 text-sm font-medium transition-colors #{current_tab == 'pending' ? 'text-gray-900 border-b-2 border-gray-900 -mb-px' : 'text-gray-500 hover:text-gray-700'}" do %>
          挑戦中 (<%= pending_entries.count %>)
        <% end %>
      </div>

      <style>
        .action-plan-grid {
          display: grid;
          grid-template-columns: 1fr;
          gap: 16px;
        }
        @media (min-width: 640px) {
          .action-plan-grid {
            grid-template-columns: repeat(3, 1fr);
          }
        }
      </style>

      <% if current_tab == 'achieved' %>
        <%# 達成タブ %>
        <% if achieved_entries.any? %>
          <div class="action-plan-grid">
            <% achieved_entries.each do |entry| %>
              <%= render 'posts/entry_card', entry: entry, post: @post %>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-8 px-4 bg-gray-50 rounded-xl">
            <p class="text-sm text-gray-500">まだ達成されたアクションがありません</p>
          </div>
        <% end %>
      <% else %>
        <%# 挑戦中タブ %>
        <% if pending_entries.any? %>
          <div class="action-plan-grid">
            <% pending_entries.each do |entry| %>
              <%= render 'posts/entry_card', entry: entry, post: @post, show_deadline: true %>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-8 px-4 bg-gray-50 rounded-xl">
            <p class="text-sm text-gray-500">挑戦中のアクションがありません</p>
          </div>
        <% end %>
      <% end %>
    </div>
  </section>
</div>
