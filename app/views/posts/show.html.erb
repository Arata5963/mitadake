<%# app/views/posts/show.html.erb %>
<%# ÂãïÁîªË©≥Á¥∞„Éö„Éº„Ç∏Ôºà„Ç∑„É≥„Éó„É´ÁâàÔºâ %>
<% content_for :title, @post.youtube_title&.truncate(30) || "ÂãïÁîªË©≥Á¥∞" %>

<div class="min-h-screen bg-white">
  <%# ===== „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢Ôºà1000pxÂπÖ„Éª‰∏≠Â§ÆÈÖçÁΩÆÔºâ ===== %>
  <div style="max-width: 1000px; margin: 0 auto; padding: 0 20px;">

    <%# Êàª„Çã„Éú„Çø„É≥ %>
    <div class="py-4">
      <% back_path = params[:from] == 'mypage' ? mypage_path : posts_path %>
      <%= link_to back_path, class: "inline-flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 transition-colors" do %>
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
        </svg>
        <span>Êàª„Çã</span>
      <% end %>
    </div>

    <%# ===== „Éí„Éº„É≠„Éº: YouTube „Çµ„É†„Éç„Ç§„É´ ===== %>
    <%= link_to @post.youtube_url,
          target: "_blank",
          rel: "noopener noreferrer",
          class: "block relative group mb-8" do %>
      <div class="aspect-video w-full rounded-lg overflow-hidden bg-gray-100">
        <%= image_tag @post.youtube_thumbnail_url(size: :hqdefault),
              alt: @post.youtube_title,
              class: "w-full h-full object-cover group-hover:scale-105 transition-transform duration-300",
              loading: "lazy",
              onerror: "this.src='#{@post.youtube_thumbnail_url(size: :mqdefault)}'" %>
      </div>
      <%# ÂÜçÁîü„Éú„Çø„É≥ %>
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="w-14 h-14 bg-black/60 rounded-full flex items-center justify-center group-hover:bg-gray-700 group-hover:scale-110 transition-all duration-300">
          <svg class="w-6 h-6 text-white ml-0.5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </div>
      </div>
      <%# YouTube „É©„Éô„É´ %>
      <div class="absolute top-3 left-3 flex items-center gap-1.5 bg-black/60 text-white text-xs px-2 py-1 rounded">
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
        </svg>
        <span>YouTube„ÅßË¶ã„Çã</span>
      </div>
    <% end %>

    <%# ===== „Çø„Ç§„Éà„É´ ===== %>
    <h1 style="font-size: 22px; font-weight: 700; color: #1a1a1a; line-height: 1.4; margin-bottom: 12px;">
      <%= @post.youtube_title %>
    </h1>

    <%# ===== „ÉÅ„É£„É≥„Éç„É´Âêç ===== %>
    <% if @post.youtube_channel_name.present? %>
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
        <% if @post.youtube_channel_thumbnail_url.present? %>
          <%= image_tag @post.youtube_channel_thumbnail_url,
                style: "width: 24px; height: 24px; border-radius: 50%; object-fit: cover;",
                alt: @post.youtube_channel_name,
                loading: "lazy" %>
        <% else %>
          <div style="width: 24px; height: 24px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center;">
            <svg style="width: 14px; height: 14px; color: #9ca3af;" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
          </div>
        <% end %>
        <p style="font-size: 14px; color: #6b7280;">
          <%= @post.youtube_channel_name %>
        </p>
      </div>
    <% end %>

    <%# ===== „É¶„Éº„Ç∂„ÉºÊï∞ & „É©„É≥„Ç≠„É≥„Ç∞ ===== %>
    <div class="mb-5" style="display: flex; align-items: center; gap: 8px;">
      <span class="text-xs text-gray-400"><%= @post.post_entries.achieved.count %>‰∫∫„Åå„Ç¢„ÇØ„Ç∑„Éß„É≥„Éó„É©„É≥„ÇíÈÅîÊàê</span>
      <% if (rank = @post.action_count_rank) %>
        <span style="display: inline-flex; align-items: center; padding: 2px 8px; background: #f3f4f6; border-radius: 10px; font-size: 11px; font-weight: 600; color: #374151;">
          TOP <%= rank %>
        </span>
      <% end %>
    </div>

    <%# ‰∏ãÈÉ®‰ΩôÁôΩ %>
    <div style="height: 24px;"></div>
  </div>

  <%# ===== „Ç¢„ÇØ„Ç∑„Éß„É≥„Éó„É©„É≥„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„Éï„É´„ÉØ„Ç§„ÉâÔºâ ===== %>
  <section style="border-top: 1px solid #f3f4f6; padding-top: 32px; margin-bottom: 32px;">
    <div style="max-width: 1000px; margin: 0 auto; padding: 0 20px;">
      <% achieved_entries = @post.post_entries.achieved.includes(:user).order(achieved_at: :desc) %>
      <h2 style="font-size: 18px; font-weight: 700; color: #1a1a1a; margin-bottom: 24px; display: flex; align-items: center; gap: 8px;">
        <span>ÈÅîÊàê„Åó„Åü„Ç¢„ÇØ„Ç∑„Éß„É≥</span>
        <span style="font-size: 14px; font-weight: 400; color: #9ca3af;">(<%= achieved_entries.count %>)</span>
      </h2>

      <%# „Ç¢„ÇØ„Ç∑„Éß„É≥„Éó„É©„É≥‰∏ÄË¶ßÔºà„Ç∞„É™„ÉÉ„ÉâË°®Á§∫Ôºâ- ÈÅîÊàêÊ∏à„Åø„ÅÆ„Åø %>
      <% if achieved_entries.any? %>
        <style>
          .action-plan-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
          }
          @media (min-width: 640px) {
            .action-plan-grid {
              grid-template-columns: repeat(3, 1fr);
            }
          }
        </style>
        <div class="action-plan-grid">
          <% achieved_entries.each do |entry| %>
            <%
              user = entry.user
              custom_thumbnail = entry.signed_thumbnail_url
              youtube_thumbnail = "https://i.ytimg.com/vi/#{@post.youtube_video_id}/mqdefault.jpg"
              display_thumbnail = custom_thumbnail.presence || youtube_thumbnail
            %>
            <article class="group">
              <div class="relative rounded-lg overflow-hidden bg-gray-100 aspect-video">
                <%= image_tag display_thumbnail,
                      alt: entry.content,
                      class: "w-full h-full object-cover group-hover:scale-105 transition-transform duration-200",
                      loading: "lazy" %>
              </div>
              <div class="pt-2">
                <p class="text-sm font-medium text-gray-900 leading-tight line-clamp-2">
                  <%= entry.content %>
                </p>
                <div class="flex items-center justify-between mt-2">
                  <%= link_to user_profile_path(user), class: "flex items-center gap-1.5 hover:opacity-80 transition-opacity" do %>
                    <% if user.avatar.present? %>
                      <%= image_tag user.avatar.url, class: "w-6 h-6 rounded-full object-cover flex-shrink-0", loading: "lazy" %>
                    <% else %>
                      <div class="w-6 h-6 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                        <span class="text-[10px] font-bold text-white"><%= user.name&.first&.upcase || '?' %></span>
                      </div>
                    <% end %>
                    <span class="text-xs text-gray-500 truncate"><%= user.name.presence || "ÂêçÁÑ°„Åó„Åï„Çì" %></span>
                  <% end %>
                  <%# „ÅÑ„ÅÑ„Å≠„Éú„Çø„É≥Ôºà„Éè„Éº„ÉàÔºâ %>
                  <% if user_signed_in? %>
                    <%= button_to toggle_flame_post_post_entry_path(@post, entry),
                          method: :post,
                          class: "flex items-center gap-1 text-xs transition-colors hover:opacity-70",
                          form: { data: { turbo_frame: "_top" } } do %>
                      <% if entry.flamed_by?(current_user) %>
                        <%# „ÅÑ„ÅÑ„Å≠Ê∏à„ÅøÔºöÂ°ó„Çä„Å§„Å∂„ÅóÔºàÊéß„Åà„ÇÅ„Éî„É≥„ÇØÔºâ %>
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="#e8a0a0">
                          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        <span style="color: #c08080;"><%= entry.entry_flames.count %></span>
                      <% else %>
                        <%# Êú™„ÅÑ„ÅÑ„Å≠Ôºö„Ç¢„Ç¶„Éà„É©„Ç§„É≥ %>
                        <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        <span class="text-gray-400"><%= entry.entry_flames.count %></span>
                      <% end %>
                    <% end %>
                  <% else %>
                    <div class="flex items-center gap-1 text-xs text-gray-400">
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                      </svg>
                      <span><%= entry.entry_flames.count %></span>
                    </div>
                  <% end %>
                </div>
              </div>
            </article>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-8 px-4 bg-gray-50 rounded-xl">
          <div class="text-4xl mb-3 opacity-50">üí≠</div>
          <p class="text-sm text-gray-500">„Åæ„Å†„Ç¢„ÇØ„Ç∑„Éß„É≥„Éó„É©„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
          <p class="text-xs text-gray-400 mt-1">ÊúÄÂàù„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Éó„É©„É≥„ÇíÊäïÁ®ø„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>
        </div>
      <% end %>
    </div>
  </section>
</div>
